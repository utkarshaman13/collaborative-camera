class CursorManager{constructor(container){this.container=container;this.cursors=new Map()}updateCursor(userId,username,color,x,y){let cursorEl=this.cursors.get(userId);if(!cursorEl){cursorEl=this.createCursor(userId,username,color);this.cursors.set(userId,cursorEl)}cursorEl.style.left=x+'px';cursorEl.style.top=y+'px';cursorEl.style.display='block'}createCursor(userId,username,color){const cursor=document.createElement('div');cursor.className='remote-cursor';cursor.innerHTML=`<div class="cursor-dot" style="background:${color}"></div><div class="cursor-label">${username}</div>`;this.container.appendChild(cursor);return cursor}removeCursor(userId){const cursor=this.cursors.get(userId);if(cursor){cursor.remove();this.cursors.delete(userId)}}hideCursor(userId){const cursor=this.cursors.get(userId);if(cursor){cursor.style.display='none'}}}class CollaborativeCanvas{constructor(){this.ws=new WebSocketClient();this.canvas=document.getElementById('mainCanvas');this.engine=new DrawingEngine(this.canvas);this.cursorManager=new CursorManager(document.getElementById('remoteCursors'));this.currentTool='brush';this.currentColor='#000000';this.currentStrokeWidth=3;this.username='';this.userColor='';this.users=new Map();this.stats={fps:0,latency:0,frameCount:0,lastTime:performance.now()};this.throttledCursor=this.throttle((x,y)=>{this.ws.send('cursor',{username:this.username,color:this.userColor,x,y})},50);this.init()}async init(){this.setupColorPresets();this.setupEventListeners();this.setupWebSocketHandlers();this.startStatsUpdate();document.getElementById('connectionModal').classList.remove('hidden')}setupColorPresets(){const colors=['#000000','#ffffff','#ff6b6b','#4ecdc4','#45b7d1','#f9ca24','#6c5ce7','#a29bfe','#fd79a8','#fdcb6e','#00b894','#e17055'];const container=document.getElementById('colorPresets');colors.forEach(color=>{const preset=document.createElement('div');preset.className='color-preset';preset.style.background=color;preset.addEventListener('click',()=>{this.currentColor=color;document.getElementById('colorPicker').value=color});container.appendChild(preset)})}setupEventListeners(){document.getElementById('joinBtn').addEventListener('click',()=>this.join());document.getElementById('usernameInput').addEventListener('keypress',(e)=>{if(e.key==='Enter')this.join()});document.querySelectorAll('[data-tool]').forEach(btn=>{btn.addEventListener('click',(e)=>{document.querySelectorAll('[data-tool]').forEach(b=>b.classList.remove('active'));btn.classList.add('active');this.currentTool=btn.dataset.tool})});document.getElementById('colorPicker').addEventListener('input',(e)=>{this.currentColor=e.target.value});const strokeWidth=document.getElementById('strokeWidth');strokeWidth.addEventListener('input',(e)=>{this.currentStrokeWidth=parseInt(e.target.value);document.getElementById('strokeWidthValue').textContent=e.target.value});document.getElementById('undoBtn').addEventListener('click',()=>this.undo());document.getElementById('redoBtn').addEventListener('click',()=>this.redo());document.getElementById('clearBtn').addEventListener('click',()=>this.clear());this.canvas.addEventListener('mousedown',(e)=>this.startDrawing(e));this.canvas.addEventListener('mousemove',(e)=>this.draw(e));this.canvas.addEventListener('mouseup',()=>this.stopDrawing());this.canvas.addEventListener('mouseleave',()=>this.stopDrawing());this.canvas.addEventListener('touchstart',(e)=>{e.preventDefault();const touch=e.touches[0];const mouseEvent=new MouseEvent('mousedown',{clientX:touch.clientX,clientY:touch.clientY});this.canvas.dispatchEvent(mouseEvent)});this.canvas.addEventListener('touchmove',(e)=>{e.preventDefault();const touch=e.touches[0];const mouseEvent=new MouseEvent('mousemove',{clientX:touch.clientX,clientY:touch.clientY});this.canvas.dispatchEvent(mouseEvent)});this.canvas.addEventListener('touchend',(e)=>{e.preventDefault();this.stopDrawing()})}setupWebSocketHandlers(){this.ws.on('init',(data)=>{if(data.users){data.users.forEach(user=>{this.users.set(user.id,user)})}if(data.operations){data.operations.forEach(op=>{this.engine.addRemoteOperation(op)})}this.updateUsers()});this.ws.on('userJoined',(data)=>{this.users.set(data.id,data);this.updateUsers()});this.ws.on('userLeft',(data)=>{this.users.delete(data.userId);this.cursorManager.removeCursor(data.userId);this.updateUsers()});this.ws.on('remoteDrawing',(data)=>this.handleRemoteDrawing(data));this.ws.on('remoteCursor',(data)=>this.handleRemoteCursor(data));this.ws.on('remoteClear',()=>this.engine.clear());this.ws.on('remoteUndo',()=>this.engine.undo());this.ws.on('remoteRedo',()=>this.engine.redo());this.ws.on('disconnect',()=>{this.updateConnectionStatus(false)})}async join(){const username=document.getElementById('usernameInput').value.trim();if(!username){alert('Please enter your name');return}try{this.username=username;await this.ws.connect(username);this.userColor=this.ws.getRandomColor();document.getElementById('connectionModal').classList.add('hidden');this.updateConnectionStatus(true)}catch(error){console.error('Failed to connect:',error);alert('Failed to connect to server. Please check if the server is running.')}}getCanvasPoint(e){const rect=this.canvas.getBoundingClientRect();return{x:e.clientX-rect.left,y:e.clientY-rect.top}}startDrawing(e){const{x,y}=this.getCanvasPoint(e);const color=this.currentTool==='eraser'?'#ffffff':this.currentColor;this.engine.startPath(x,y,color,this.currentStrokeWidth,this.currentTool)}draw(e){const{x,y}=this.getCanvasPoint(e);this.throttledCursor(x,y);if(this.engine.isDrawing){this.engine.addPoint(x,y)}}stopDrawing(){const path=this.engine.endPath();if(path){this.ws.send('draw',{username:this.username,color:this.userColor,points:path.points,strokeWidth:path.strokeWidth,tool:path.tool})}}handleRemoteDrawing(data){if(data.userId===this.ws.userId)return;const operation={points:data.points,color:data.tool==='eraser'?'#ffffff':data.color,strokeWidth:data.strokeWidth,tool:data.tool,timestamp:Date.now()};this.engine.addRemoteOperation(operation);this.stats.latency=Date.now()-(data.timestamp||operation.timestamp)}handleRemoteCursor(data){if(data.userId===this.ws.userId)return;this.cursorManager.updateCursor(data.userId,data.username,data.color,data.x,data.y)}undo(){const operation=this.engine.undo();if(operation){this.ws.send('undo',{timestamp:Date.now()})}}redo(){const operation=this.engine.redo();if(operation){this.ws.send('redo',{timestamp:Date.now()})}}clear(){if(confirm('Clear the entire canvas? This will affect all users.')){this.engine.clear();this.ws.send('clear',{timestamp:Date.now()})}}updateUsers(){const container=document.getElementById('onlineUsers');let html=`<div class="user-item"><div class="user-color" style="background:${this.userColor}"></div><div class="user-name">${this.username}</div><span class="you-badge">YOU</span></div>`;this.users.forEach((user,id)=>{if(id!==this.ws.userId){html+=`<div class="user-item"><div class="user-color" style="background:${user.color}"></div><div class="user-name">${user.username}</div></div>`}});container.innerHTML=html;document.getElementById('userCount').textContent=this.users.size+1}updateConnectionStatus(connected){const indicator=document.getElementById('statusIndicator');const text=document.getElementById('statusText');if(connected){indicator.classList.add('connected');text.textContent='Connected'}else{indicator.classList.remove('connected');text.textContent='Disconnected'}}startStatsUpdate(){let frameCount=0;let lastFpsUpdate=performance.now();const updateStats=()=>{frameCount++;const now=performance.now();if(now-lastFpsUpdate>=1000){this.stats.fps=Math.round(frameCount*1000/(now-lastFpsUpdate));document.getElementById('fpsCounter').textContent=this.stats.fps;document.getElementById('latencyCounter').textContent=this.stats.latency;document.getElementById('opsCounter').textContent=this.engine.getOperationCount();frameCount=0;lastFpsUpdate=now}requestAnimationFrame(updateStats)};requestAnimationFrame(updateStats)}throttle(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}}document.addEventListener('DOMContentLoaded',()=>{const app=new CollaborativeCanvas()});