class DrawingEngine{constructor(canvas){this.canvas=canvas;this.ctx=canvas.getContext('2d',{willReadFrequently:false});this.operations=[];this.redoStack=[];this.currentPath=null;this.isDrawing=false;this.setupCanvas()}setupCanvas(){this.resizeCanvas();window.addEventListener('resize',()=>this.resizeCanvas());this.ctx.lineCap='round';this.ctx.lineJoin='round'}resizeCanvas(){const rect=this.canvas.parentElement.getBoundingClientRect();this.canvas.width=rect.width;this.canvas.height=rect.height;this.redrawAll()}startPath(x,y,color,strokeWidth,tool){this.currentPath={points:[{x,y}],color,strokeWidth,tool,timestamp:Date.now()};this.isDrawing=true}addPoint(x,y){if(!this.isDrawing||!this.currentPath)return;this.currentPath.points.push({x,y});this.drawPath(this.currentPath,this.currentPath.points.length-2)}endPath(){if(!this.currentPath)return;this.isDrawing=false;if(this.currentPath.points.length>1){this.operations.push(this.currentPath);this.redoStack=[];return this.currentPath}this.currentPath=null;return null}drawPath(path,startIndex=0){const{points,color,strokeWidth,tool}=path;if(points.length<2)return;this.ctx.save();if(tool==='eraser'){this.ctx.globalCompositeOperation='destination-out';this.ctx.strokeStyle='rgba(0,0,0,1)'}else{this.ctx.globalCompositeOperation='source-over';this.ctx.strokeStyle=color}this.ctx.lineWidth=strokeWidth;this.ctx.beginPath();const start=Math.max(0,startIndex);if(start===0){this.ctx.moveTo(points[0].x,points[0].y)}else{this.ctx.moveTo(points[start].x,points[start].y)}for(let i=start+1;i<points.length;i++){this.ctx.lineTo(points[i].x,points[i].y)}this.ctx.stroke();this.ctx.restore()}redrawAll(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.operations.forEach(op=>this.drawPath(op))}undo(){if(this.operations.length===0)return null;const operation=this.operations.pop();this.redoStack.push(operation);this.redrawAll();return operation}redo(){if(this.redoStack.length===0)return null;const operation=this.redoStack.pop();this.operations.push(operation);this.drawPath(operation);return operation}clear(){this.operations=[];this.redoStack=[];this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}addRemoteOperation(operation){this.operations.push(operation);this.drawPath(operation)}getOperationCount(){return this.operations.length}}